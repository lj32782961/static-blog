<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文本选择弹窗改进版</title>
    <style>
        #contextMenu {
            position: absolute;
            background: white;
            border: 1px solid #ccc;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
            padding: 5px;
            z-index: 1000;
            display: none;
            min-width: 100px;
        }

        #contextMenu div {
            padding: 5px 10px;
            cursor: pointer;
        }

        #contextMenu div:hover {
            background: #f0f0f0;
        }

        #copyMessage {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            display: none;
        }

        #translatePopup {
            position: absolute;
            background: white;
            border: 1px solid #ccc;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
            padding: 10px;
            z-index: 1001;
            display: none;
        }

        #translatePopup textarea {
            width: 200px;
            height: 100px;
            resize: none;
            margin-bottom: 5px;
        }

        #translatePopup button {
            display: block;
            margin: 0 auto;
            padding: 5px 10px;
        }
    </style>
</head>
<body>
    <p>这是一段测试文本，你可以选中任何文字试试效果。这是一段测试文本，你可以选中任何文字试试效果。</p>
    <p>1 Introduction
        The transparency and the potential to manufacture photovoltaic (PV) devices based on organic materials (OPV) on flexible substrates allow numerous smart design opportunities as well as roll-to-roll mass production. (1) However, challenges such as the limited resource of the rare metal indium and the resulting high cost of the commonly used indium tin oxide (ITO) are still present. ITO is primarily used as the transparent electrode material in organic electronic devices. In addition, the brittleness of ITO limits the roll-to-roll (R2R) processing of organic solar cells with printing technologies. This limitation is essentially due to the fact that the efficiency of OPV devices was shown to decrease rapidly with the number of bending cycles. (2) Flexibility, (3) however, is one of the main advantages of OPV devices over conventional PV devices. To substitute ITO as the transparent conducting electrode, several attempts have been made using organic materials such as carbon nanotubes, (4) graphene, (5) or conducting polymers. (2, 6-10) In this context, the polymer blend poly(3,4-ethylenedioxythiophene):poly(styrene-sulfonate) (PEDOT:PSS) has attracted a great deal of attention, particularly in combination with cosolvent modification, (2, 7, 8, 11-14) and is used in R2R processes as the standard electrode. (15) Further, in dye-sensitized solar cells, PEDOT:PSS modified with cosolvents has begun to be used as an electrode replacement. (16) Even in silicon research, PEDOT:PSS has begun to find its application by combining silicon and polymers in photovoltaic and/or artificial photosynthetic systems. (17) The promising properties of PEDOT:PSS, such as its solution processability, a high optical transparency, its easy and cheap commercial availability, its hole conductivity, and its mechanical flexibility, make PEDOT:PSS desirable for application in optoelectronic devices and use as a widely used electron blocking layer. Besides, for its application in photovoltaic devices, PEDOT:PSS already plays a crucial role in ot</p>
    <div id="contextMenu"></div>
    <div id="copyMessage">复制成功！</div>
    <div id="translatePopup">
        <textarea readonly></textarea>
        <button onclick="closeTranslatePopup()">关闭</button>
    </div>

    <script>
        let selectedText = '';
        const contextMenu = document.getElementById('contextMenu');
        const copyMessage = document.getElementById('copyMessage');
        const translatePopup = document.getElementById('translatePopup');
        const translateTextarea = translatePopup.querySelector('textarea');
        let touchTimer;

        // PC端事件
        document.addEventListener('mouseup', handleSelection);
        document.addEventListener('contextmenu', (e) => e.preventDefault());

        // 移动端事件
        document.addEventListener('touchstart', startTouch);
        document.addEventListener('touchend', endTouch);
        document.addEventListener('touchmove', cancelTouch);

        function startTouch(event) {
            touchTimer = setTimeout(() => {
                handleSelection(event);
            }, 500); // 长按500ms触发
        }

        function endTouch(event) {
            clearTimeout(touchTimer);
            handleSelection(event);
        }

        function cancelTouch() {
            clearTimeout(touchTimer);
        }

        // 调整弹窗位置的通用函数
        function adjustPopupPosition(popup, rect) {
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            const popupWidth = popup.offsetWidth;
            const popupHeight = popup.offsetHeight;

            let top = rect.bottom + window.scrollY;
            let left = rect.left + window.scrollX;

            // 调整左右边界
            if (left + popupWidth > viewportWidth) {
                left = rect.right + window.scrollX - popupWidth; // 对齐到选择区域右边缘
                if (left < 0) left = 0; // 防止超出左边界
            }

            // 调整上下边界
            if (top + popupHeight > viewportHeight + window.scrollY) {
                top = rect.top + window.scrollY - popupHeight; // 显示在选择区域上方
                if (top < window.scrollY) top = window.scrollY; // 防止超出上边界
            }

            popup.style.top = `${top}px`;
            popup.style.left = `${left}px`;
        }

        function handleSelection(event) {
            selectedText = window.getSelection().toString().trim();
            // console.log(selectedText);
            if (selectedText) {
                const selection = window.getSelection();
                const range = selection.getRangeAt(0);
                const rect = range.getBoundingClientRect();

                // 设置菜单位置
                // contextMenu.style.top = `${rect.bottom + window.scrollY}px`;
                // contextMenu.style.left = `${rect.left + window.scrollX}px`;
                
                // 菜单内容
                contextMenu.innerHTML = `
                    <div onclick="copyText(this)" data-selected="${selectedText}">复制</div>
                    <div onclick="translateText(this)" data-selected="${selectedText}">翻译</div>
                `;
                contextMenu.style.display = 'block';

                // 调整位置
                adjustPopupPosition(contextMenu, rect);

                // 关闭翻译弹窗（如果已打开）
                translatePopup.style.display = 'none';
            }
        }

        // 点击其他地方关闭菜单
        document.addEventListener('click', (event) => {
            if (!contextMenu.contains(event.target) && !translatePopup.contains(event.target)) {
                contextMenu.style.display = 'none';
                translatePopup.style.display = 'none';
            }
        });

        // 复制
        function copyText(element) {
            const selectedText = element.dataset.selected;
            console.log('尝试复制的文本:', selectedText); // 调试用

            if (!selectedText) {
                console.error('没有选中文本');
                alert('没有选中文本可复制');
                contextMenu.style.display = 'none';
                return;
            }
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(selectedText)
                    .then(() => {
                        showCopySuccess();
                    })
                    .catch(err => {
                        console.error('Clipboard API 复制失败:', err);
                        fallbackCopy(selectedText); // 使用备用方案
                    });
            } else {
                // Clipboard API 不可用时使用备用方案
                fallbackCopy(selectedText);
            }
        }

        // 备用复制方案
        function fallbackCopy(text) {
            const tempInput = document.createElement('textarea');
            tempInput.value = text;
            document.body.appendChild(tempInput);
            tempInput.select();
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showCopySuccess();
                } else {
                    console.error('备用复制失败');
                    alert('复制失败，请手动复制');
                }
            } catch (err) {
                console.error('备用复制异常:', err);
                alert('复制失败，请手动复制');
            }
            document.body.removeChild(tempInput);
        }

        // 显示复制成功提示
        function showCopySuccess() {
            copyMessage.style.display = 'block';
            setTimeout(() => {
                copyMessage.style.display = 'none';
            }, 2000);
            contextMenu.style.display = 'none';
        }

        // 翻译功能
        function translateText(element) {
            const selectedText = element.dataset.selected;
            const textToTranslate = selectedText
            const translations = {
                '测试': 'test',
                '文字': 'text',
                '效果': 'effect'
            };
            const translated = translations[textToTranslate] || '翻译结果：' + textToTranslate.split('').join('');
            
            // 关闭原始菜单
            contextMenu.style.display = 'none';

            // 显示翻译弹窗
            const rect = window.getSelection().getRangeAt(0).getBoundingClientRect();
            translateTextarea.value = translated;
            translatePopup.style.display = 'block';

            // 调整翻译弹窗位置
            adjustPopupPosition(translatePopup, rect);
        }

        // 关闭翻译弹窗
        function closeTranslatePopup() {
            translatePopup.style.display = 'none';
        }
    </script>
</body>
</html>