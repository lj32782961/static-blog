<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能选择菜单最终版</title>
    <style>
        #contextMenu {
            position: absolute;
            background: white;
            border: 1px solid #ccc;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
            padding: 5px;
            z-index: 1000;
            display: none;
            min-width: 120px;
            white-space: nowrap;
            border-radius: 4px;
        }

        #contextMenu:before {
            content: '';
            position: absolute;
            width: 12px;
            height: 12px;
            background: white;
            transform: rotate(45deg);
            top: -6px;
            left: 20px;
            box-shadow: -2px -2px 5px rgba(0, 0, 0, 0.05);
            z-index: -1;
        }

        #contextMenu.upward:before {
            top: auto;
            bottom: -6px;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.05);
        }

        .menu-item {
            padding: 8px 16px;
            cursor: pointer;
            color: #333;
            transition: all 0.2s;
            display: inline-block;
            position: relative;
        }

        .menu-item:hover {
            background: #f5f5f5;
        }

        .menu-item.active {
            background: #e0e0e0 !important;
        }

        .menu-divider {
            display: inline-block;
            color: #ddd;
            margin: 0 2px;
        }

        #translatePopup {
            position: fixed;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            padding: 15px;
            z-index: 1001;
            display: none;
            max-width: 300px;
        }

        #translatePopup textarea {
            width: 100%;
            height: 100px;
            resize: none;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 8px;
            font-family: inherit;
        }

        #translatePopup button {
            display: block;
            margin: 0 auto;
            padding: 8px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }

        #translatePopup button:hover {
            background: #0056b3;
        }

        #copyMessage {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            display: none;
            z-index: 1002;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <article>
        <h2>请选择任意文本测试</h2>
        <p>这是一个智能选择菜单示例，支持跨行选择和移动端操作。尝试不同方向的文本选择，菜单会自动跟随选区位置。</p>
        <p>测试文本：人工智能是未来科技发展的核心方向。通过深度学习和自然语言处理技术，我们可以实现更智能的人机交互。跨行选择测试：Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.</p>
    </article>

    <div id="contextMenu"></div>
    <div id="copyMessage">✓ 已复制到剪贴板</div>
    <div id="translatePopup">
        <textarea readonly></textarea>
        <button onclick="closeTranslatePopup()">关闭翻译</button>
    </div>

    <script>
        const contextMenu = document.getElementById('contextMenu');
        const copyMessage = document.getElementById('copyMessage');
        const translatePopup = document.getElementById('translatePopup');
        const translateTextarea = translatePopup.querySelector('textarea');

        let lastPosition = { x: 0, y: 0 };
        let isSelecting = false;
        let touchTimer;

        // 事件监听
        document.addEventListener('mouseup', handleSelection);
        document.addEventListener('contextmenu', (e) => e.preventDefault());
        document.addEventListener('touchstart', handleTouchStart);
        document.addEventListener('touchend', handleTouchEnd);
        document.addEventListener('touchmove', handleTouchMove);
        document.addEventListener('selectionchange', handleSelectionChange);
        document.addEventListener('click', handleOutsideClick);

        function handleSelection(e) {
            const selection = window.getSelection();
            const text = selection.toString().trim();
            
            if (!text) {
                hideAllPopups();
                return;
            }

            updateMenuPosition(selection, e);
        }

        function updateMenuPosition(selection, event) {
            const range = selection.rangeCount > 0 ? selection.getRangeAt(0) : null;
            const rects = range ? Array.from(range.getClientRects()) : [];
            const eventPos = getEventPosition(event);

            let anchorX, anchorY;

            if (rects.length > 0) {
                const firstRect = rects[0];
                const lastRect = rects[rects.length - 1];
                const isDownward = eventPos.y > firstRect.top;
                
                anchorX = (lastRect.left + lastRect.right) / 2;
                anchorY = isDownward ? lastRect.bottom : firstRect.top;
            } else {
                anchorX = eventPos.x;
                anchorY = eventPos.y;
            }

            showContextMenu(selection.toString().trim(), anchorX, anchorY);
        }

        function showContextMenu(text, x, y) {
            contextMenu.innerHTML = `
                <div class="menu-item" onclick="handleAction('copy', '${sanitizeText(text)}')">复制</div>
                <div class="menu-divider">|</div>
                <div class="menu-item" onclick="handleAction('translate', '${sanitizeText(text)}')">翻译</div>
            `;
            
            smartPosition(contextMenu, x, y);
            lastPosition = { x, y };
            contextMenu.style.display = 'block';
        }

        function handleAction(action, text) {
            const item = event.target;
            item.classList.add('active');
            
            setTimeout(() => {
                item.classList.remove('active');
                contextMenu.style.display = 'none';
            }, 200);

            if (action === 'copy') {
                copyText(text);
            } else {
                showTranslation(text);
            }
        }

        function smartPosition(element, x, y) {
            element.style.display = 'block';
            const rect = element.getBoundingClientRect();
            const viewport = {
                width: window.innerWidth,
                height: window.innerHeight
            };

            // 垂直调整
            let top = y;
            if (y + rect.height > viewport.height - 10) {
                top = y - rect.height - 10;
                element.classList.add('upward');
            } else {
                element.classList.remove('upward');
                top += 10;
            }

            // 水平调整
            let left = x - rect.width / 2;
            left = Math.max(10, Math.min(left, viewport.width - rect.width - 10));

            element.style.top = `${top + window.scrollY}px`;
            element.style.left = `${left + window.scrollX}px`;
        }

        // 移动端处理
        function handleTouchStart(e) {
            touchTimer = setTimeout(() => {
                isSelecting = true;
                handleSelection(e);
            }, 500);
        }

        function handleTouchEnd() {
            clearTimeout(touchTimer);
            isSelecting = false;
        }

        function handleTouchMove() {
            clearTimeout(touchTimer);
        }

        function handleSelectionChange() {
            if (isSelecting) {
                const selection = window.getSelection();
                if (selection.toString().trim()) {
                    requestAnimationFrame(() => updateMenuPosition(selection));
                }
            }
        }

        function handleOutsideClick(e) {
            if (!contextMenu.contains(e.target) && !translatePopup.contains(e.target)) {
                hideAllPopups();
            }
        }

        function hideAllPopups() {
            contextMenu.style.display = 'none';
            translatePopup.style.display = 'none';
        }

        function copyText(text) {
            navigator.clipboard.writeText(text)
                .then(() => {
                    copyMessage.style.display = 'block';
                    setTimeout(() => copyMessage.style.display = 'none', 1500);
                })
                .catch(() => fallbackCopy(text));
        }

        function fallbackCopy(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
        }

        function showTranslation(text) {
            translateTextarea.value = mockTranslate(text);
            smartPosition(translatePopup, lastPosition.x, lastPosition.y);
            translatePopup.style.display = 'block';
        }

        function mockTranslate(text) {
            // 模拟翻译结果
            const translations = {
                '测试': 'Test',
                '人工智能': 'Artificial Intelligence',
                '深度学习': 'Deep Learning'
            };
            return translations[text] || `Translation: ${text}`;
        }

        function closeTranslatePopup() {
            translatePopup.style.display = 'none';
        }

        function getEventPosition(e) {
            if (e.touches) {
                const touch = e.touches[0] || e.changedTouches[0];
                return { x: touch.clientX, y: touch.clientY };
            }
            return { x: e.clientX, y: e.clientY };
        }

        function sanitizeText(text) {
            return text.replace(/'/g, "\\'").replace(/"/g, '&quot;');
        }
    </script>
</body>
</html>